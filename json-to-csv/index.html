<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON to CSV Converter - 0mod</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            black: '#0f172a',
                            gray: '#f8fafc',
                            accent: '#10b981',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../shared/base.css">
    <meta name="description" content="Convert JSON data to CSV format instantly in your browser.">
</head>
<body class="bg-brand-gray dark:bg-slate-950 min-h-screen font-sans text-slate-800 dark:text-slate-100 antialiased transition-colors duration-200">
    
    <div id="app" class="max-w-5xl mx-auto px-4 py-12">
        <header class="flex justify-center items-center mb-12">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">JSON to CSV</h1>
                <p class="text-slate-600 dark:text-slate-400 max-w-md mx-auto">Convert JSON data to CSV format instantly in your browser. Your data never leaves your device.</p>
            </div>
        </header>

        <div id="tool-content" class="space-y-6">
            <!-- Dynamic content -->
        </div>

        <footer class="mt-12 pt-8 border-t border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <span class="text-xs font-medium text-slate-400">v1.1.0</span>
                <button onclick="handleShare()" class="text-xs font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 dark:hover:text-emerald-300 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    Share Tool
                </button>
                <button onclick="handleBookmark()" class="text-xs font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                    Bookmark Tool
                </button>
            </div>
            <div class="flex items-center gap-2 text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                üõ°Ô∏è Zero Uploads ‚Ä¢ 100% Private
            </div>
        </footer>
    </div>

    <script src="../shared/ui-kit.js"></script>
    <script src="../shared/icons.js"></script>
    <script>
        // State
        const state = {
            jsonInput: '',
            csvOutput: '',
            tableData: null, // { headers: [], rows: [] }
            error: null,
            filename: 'converted',
            isProcessing: false,
            viewMode: 'table' // 'table' or 'raw'
        };

        // Logic
        function flattenObject(obj, prefix = '') {
            return Object.keys(obj).reduce((acc, k) => {
                const pre = prefix.length ? prefix + '.' : '';
                if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                    Object.assign(acc, flattenObject(obj[k], pre + k));
                } else {
                    acc[pre + k] = obj[k];
                }
                return acc;
            }, {});
        }

        function processData(input) {
            let array = typeof input !== 'object' ? JSON.parse(input) : input;
            
            // Wrap non-array objects in an array
            if (!Array.isArray(array)) {
                array = [array];
            }

            if (array.length === 0) {
                throw new Error("Input must be a non-empty object or array of objects.");
            }

            // Flatten all objects and collect all unique keys for headers
            const flattenedArray = array.map(obj => {
                if (typeof obj !== 'object' || obj === null) {
                    return { value: obj };
                }
                return flattenObject(obj);
            });

            const allKeys = new Set();
            flattenedArray.forEach(obj => {
                Object.keys(obj).forEach(key => allKeys.add(key));
            });

            const headers = Array.from(allKeys);
            let csvStr = headers.join(',') + '\r\n';
            const rows = [];

            for (let i = 0; i < flattenedArray.length; i++) {
                let line = '';
                const rowData = [];
                for (let j = 0; j < headers.length; j++) {
                    if (line !== '') line += ',';
                    
                    let value = flattenedArray[i][headers[j]];
                    if (value === undefined || value === null) {
                        value = '';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }

                    let valueStr = String(value);
                    // Escape quotes and wrap in quotes if needed
                    if (valueStr.includes(',') || valueStr.includes('"') || valueStr.includes('\n')) {
                        valueStr = '"' + valueStr.replace(/"/g, '""') + '"';
                    }
                    line += valueStr;
                    
                    // For table display, we might want to truncate very long strings or objects
                    let displayValue = value;
                    if (typeof value === 'object') displayValue = JSON.stringify(value);
                    rowData.push(displayValue);
                }
                csvStr += line + '\r\n';
                rows.push(rowData);
            }

            return { headers, rows, csvString: csvStr };
        }

        function handleConvert() {
            console.log('handleConvert called');
            state.error = null;
            state.csvOutput = '';
            state.tableData = null;
            state.isProcessing = true;
            render();

            // Small timeout to allow UI to update
            setTimeout(() => {
                try {
                    console.log('Processing JSON:', state.jsonInput);
                    if (!state.jsonInput.trim()) {
                        throw new Error("Please enter some JSON.");
                    }
                    const parsed = JSON.parse(state.jsonInput);
                    const result = processData(parsed);
                    console.log('Result:', result);
                    state.csvOutput = result.csvString;
                    state.tableData = { headers: result.headers, rows: result.rows };
                } catch (e) {
                    console.error('Error:', e);
                    state.error = e.message;
                } finally {
                    state.isProcessing = false;
                    render();
                }
            }, 50);
        }

        function handleCopy() {
            navigator.clipboard.writeText(state.csvOutput);
            alert('Copied to clipboard!');
        }

        function handleDownload() {
            const blob = new Blob([state.csvOutput], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${state.filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function handleClear() {
             if (confirm('Clear all data?')) {
                state.jsonInput = '';
                state.csvOutput = '';
                state.error = null;
                state.filename = 'converted';
                render();
            }
        }

        // Render
        function render() {
            const content = document.getElementById('tool-content');
            
            const inputSection = `
                <div>
                    ${zm.ui.TextArea({
                        id: 'json-input',
                        label: 'JSON Input',
                        placeholder: '[{"name": "John", "age": 30}, {"name": "Jane", "age": 25}]',
                        value: state.jsonInput,
                        rows: 12
                    })}
                    <div class="mt-4 flex gap-4">
                        ${zm.ui.Button({
                            text: state.isProcessing ? 'Converting...' : 'Convert to CSV',
                            onClick: 'window.triggerConvert()',
                            variant: 'primary',
                            className: 'flex-1'
                        })}
                        ${state.jsonInput ? zm.ui.Button({
                            text: 'Clear',
                            onClick: 'window.triggerClear()',
                            variant: 'ghost',
                            className: ''
                        }) : ''}
                    </div>
                </div>
            `;

            let outputContent = '';
            if (state.csvOutput) {
                const tableHtml = state.tableData ? `
                    <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm mb-6 max-h-[500px]">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 relative">
                            <thead class="sticky top-0 z-10">
                                <tr>
                                    ${state.tableData.headers.map(h =>
                                        `<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 whitespace-nowrap">${h}</th>`
                                    ).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-700">
                                ${state.tableData.rows.map(row =>
                                    `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                        ${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-300 max-w-xs truncate" title="${String(cell).replace(/"/g, '"')}">${cell}</td>`).join('')}
                                    </tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '';

                const rawHtml = zm.ui.TextArea({
                    id: 'csv-output',
                    label: 'Raw CSV',
                    value: state.csvOutput,
                    rows: 12,
                    className: 'font-mono text-sm'
                });

                outputContent = `
                    <div class="mt-8 pt-8 border-t border-slate-200 dark:border-slate-800">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Result</h3>
                            <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                                <button onclick="window.setViewMode('table')" class="px-3 py-1 text-sm font-medium rounded-md transition-colors ${state.viewMode === 'table' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}">Table</button>
                                <button onclick="window.setViewMode('raw')" class="px-3 py-1 text-sm font-medium rounded-md transition-colors ${state.viewMode === 'raw' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}">Raw CSV</button>
                            </div>
                        </div>

                        ${state.viewMode === 'table' ? tableHtml : rawHtml}
                        
                        <div class="mt-4 mb-8">
                             ${zm.ui.Button({
                                text: `<div class="flex items-center space-x-2">${zm.icons.Clipboard || 'üìã'} <span>Copy CSV to Clipboard</span></div>`,
                                onClick: 'window.triggerCopy()',
                                variant: 'secondary',
                                className: 'w-full sm:w-auto'
                            })}
                        </div>

                        ${zm.ui.DownloadSection({
                            id: 'download',
                            filename: state.filename,
                            extension: '.csv',
                            onFilenameChange: 'window.updateFilename(event)',
                            onDownload: 'window.triggerDownload()',
                            onReset: 'window.triggerClear()'
                        })}
                    </div>
                `;
            }

            content.innerHTML = `
                ${state.error ? zm.ui.Alert({ title: 'Error', message: state.error, type: 'error' }) : ''}
                ${zm.ui.Card({ content: inputSection })}
                ${outputContent}
            `;

            // Re-attach listeners
            const jsonInputEl = document.getElementById('json-input');
            if (jsonInputEl) {
                jsonInputEl.addEventListener('input', (e) => {
                    state.jsonInput = e.target.value;
                });
            }
        }

        // Global handlers
        window.triggerConvert = handleConvert;
        window.triggerCopy = handleCopy;
        window.triggerDownload = handleDownload;
        window.triggerClear = handleClear;
        window.updateFilename = (e) => { state.filename = e.target.value; };
        window.setViewMode = (mode) => { state.viewMode = mode; render(); };
        
        window.handleShare = () => {
            if (navigator.share) {
                navigator.share({
                    title: 'JSON to CSV - 0mod',
                    text: 'Convert JSON to CSV securely in your browser with 0mod.',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        };

        window.handleBookmark = () => {
            navigator.clipboard.writeText(window.location.href);
            alert('URL copied to clipboard! Press Ctrl+D (Cmd+D on Mac) to bookmark this page.');
        };

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        document.documentElement.dataset.theme = savedTheme;

        // Initial render
        render();
    </script>
</body>
</html>
