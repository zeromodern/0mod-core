<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merge - 0mod</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            black: '#0f172a',
                            gray: '#f8fafc',
                            accent: '#10b981',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="../shared/base.css">
    <style>
        .shadow-soft {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 10px -2px rgba(0, 0, 0, 0.03);
        }
    </style>
</head>
<body class="bg-brand-gray dark:bg-slate-950 min-h-screen font-sans text-slate-800 dark:text-slate-100 antialiased transition-colors duration-200">
    
    <!-- TOOL UI START -->
    <div id="app" class="max-w-5xl mx-auto px-4 py-12">
        <header class="flex justify-center items-center">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">PDF Merge</h1>
                <p class="text-slate-600 dark:text-slate-400 max-w-md">Combine multiple PDF files into one document securely in your browser. Your files never leave your device.</p>
            </div>
        </header>

        <div id="tool-content" class="space-y-6">
            <!-- Dynamic content injected here -->
        </div>

        <footer class="mt-12 pt-8 border-t border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <span class="text-xs font-medium text-slate-400">v1.1.0</span>
                <button onclick="handleShare()" class="text-xs font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 dark:hover:text-emerald-300 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    Share Tool
                </button>
                <button onclick="handleBookmark()" class="text-xs font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                    Bookmark Tool
                </button>
            </div>
            <div class="flex items-center gap-2 text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                üõ°Ô∏è Zero Uploads ‚Ä¢ 100% Private
            </div>
        </footer>
    </div>
    <!-- TOOL UI END -->

    <script src="../shared/ui-kit.js"></script>
    <script src="../shared/icons.js"></script>
    <script>
        const state = {
            files: [], // Array of { file, thumbnail }
            isProcessing: false,
            error: null,
            mergedUrl: null,
            outputFilename: ''
        };

        // Configure PDF.js worker
        function initPdfJs() {
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            } else {
                console.error('pdfjsLib not loaded');
            }
        }

        function render() {
            const content = document.getElementById('tool-content');
            
            content.innerHTML = `
                ${state.error ? zm.ui.Alert({ title: 'Error', message: state.error, type: 'error' }) : ''}

                <div class="space-y-6">
                    ${zm.ui.Card({
                        title: 'Select PDFs',
                        content: `
                            ${zm.ui.FileUpload({ id: 'pdf-select', accept: '.pdf', multiple: true, fileTypeLabel: 'PDF files only' })}
                            <div id="file-list" class="mt-6 space-y-2">
                                ${renderFileList()}
                            </div>
                        `
                    })}

                    <div class="flex flex-col items-center gap-4">
                        ${zm.ui.Button({
                            text: state.isProcessing ? 'Merging...' : 'Merge PDFs',
                            onClick: 'handleMerge()',
                            variant: 'primary',
                            className: `w-full sm:w-auto px-12 py-4 text-lg ${state.files.length < 2 || state.isProcessing ? 'opacity-50 cursor-not-allowed' : ''}`,
                            type: 'button'
                        })}
                        
                        ${state.files.length > 0 ? `
                            <button onclick="clearFiles()" class="text-sm text-slate-400 hover:text-red-500 transition-colors">
                                Clear all files
                            </button>
                        ` : ''}
                    </div>

                    ${state.mergedUrl ? zm.ui.DownloadSection({
                        id: 'download',
                        filename: state.outputFilename,
                        extension: '.pdf',
                        onFilenameChange: 'window.updateFilename(event)',
                        onDownload: 'window.handleDownload()',
                        onReset: 'window.clearFiles()'
                    }) : ''}
                </div>
            `;

            setupEventListeners();
        }

        function renderFileList() {
            if (state.files.length === 0) {
                return '<p class="text-center text-slate-400 py-8 border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-xl">No files selected yet</p>';
            }

            return state.files.map(({ file, thumbnail }, index) => `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl shadow-sm group hover:border-emerald-500/50 transition-colors">
                    <div class="flex items-center overflow-hidden">
                        <span class="text-slate-300 dark:text-slate-700 mr-4 font-mono text-sm font-bold">${(index + 1).toString().padStart(2, '0')}</span>
                        <div class="w-12 h-16 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 mr-4 flex-shrink-0 overflow-hidden flex items-center justify-center shadow-inner">
                            ${thumbnail ? `<img src="${thumbnail}" class="w-full h-full object-cover" />` : `<span class="text-[10px] font-bold text-slate-400">PDF</span>`}
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="truncate text-sm font-semibold text-slate-700 dark:text-slate-200">${file.name}</span>
                            <span class="text-xs text-slate-400 font-medium">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1 ml-4 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="moveFile(${index}, -1)" class="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-lg disabled:opacity-0" ${index === 0 ? 'disabled' : ''}>
                            ${zm.icons.ArrowUp || '‚Üë'}
                        </button>
                        <button onclick="moveFile(${index}, 1)" class="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-lg disabled:opacity-0" ${index === state.files.length - 1 ? 'disabled' : ''}>
                            ${zm.icons.ArrowDown || '‚Üì'}
                        </button>
                        <button onclick="removeFile(${index})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
                            ${zm.icons.Trash || '√ó'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            const dropzone = document.getElementById('pdf-select-dropzone');
            const input = document.getElementById('pdf-select');

            if (dropzone && input) {
                dropzone.onclick = () => input.click();
                
                input.onchange = async (e) => {
                    const newFiles = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
                    await handleNewFiles(newFiles);
                };

                dropzone.ondragover = (e) => {
                    e.preventDefault();
                    dropzone.classList.add('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20');
                };

                dropzone.ondragleave = () => {
                    dropzone.classList.remove('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20');
                };

                dropzone.ondrop = async (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20');
                    const newFiles = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
                    await handleNewFiles(newFiles);
                };
            }
        }

        async function handleNewFiles(newFiles) {
            const fileObjects = newFiles.map(file => ({ file, thumbnail: null }));
            state.files = [...state.files, ...fileObjects];
            state.mergedUrl = null;
            if (state.files.length > 0 && (!state.outputFilename || state.outputFilename === 'merged')) {
                state.outputFilename = state.files[0].file.name.split('.').slice(0, -1).join('.') + '-merged';
            }
            render();

            // Generate thumbnails asynchronously
            for (const obj of fileObjects) {
                try {
                    obj.thumbnail = await generateThumbnail(obj.file);
                    render();
                } catch (err) {
                    console.error('Thumbnail generation failed', err);
                }
            }
        }

        async function generateThumbnail(file) {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);
            
            const viewport = page.getViewport({ scale: 0.3 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;

            return canvas.toDataURL();
        }

        window.removeFile = (index) => {
            state.files.splice(index, 1);
            state.mergedUrl = null;
            if (state.files.length > 0 && index === 0) {
                state.outputFilename = state.files[0].file.name.split('.').slice(0, -1).join('.') + '-merged';
            }
            render();
        };

        window.clearFiles = () => {
            if (confirm('Clear all selected files?')) {
                state.files = [];
                state.mergedUrl = null;
                state.outputFilename = '';
                render();
            }
        };

        window.moveFile = (index, direction) => {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < state.files.length) {
                const temp = state.files[index];
                state.files[index] = state.files[newIndex];
                state.files[newIndex] = temp;
                state.mergedUrl = null;
                render();
            }
        };

        window.handleMerge = async () => {
            if (state.files.length < 2 || state.isProcessing) return;

            state.isProcessing = true;
            state.error = null;
            state.mergedUrl = null;
            render();

            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();

                for (const { file } of state.files) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                state.mergedUrl = URL.createObjectURL(blob);
            } catch (err) {
                console.error(err);
                state.error = 'Failed to merge PDFs. Please ensure all files are valid PDF documents.';
            } finally {
                state.isProcessing = false;
                render();
            }
        };

        window.handleDownload = () => {
            if (!state.mergedUrl) return;
            const a = document.createElement('a');
            a.href = state.mergedUrl;
            a.download = `${state.outputFilename}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        window.updateFilename = (event) => { state.outputFilename = event.target.value; };

        window.handleShare = () => {
            if (navigator.share) {
                navigator.share({
                    title: 'PDF Merge - 0mod',
                    text: 'Merge PDFs securely in your browser with 0mod.',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        };

        window.handleBookmark = () => {
            navigator.clipboard.writeText(window.location.href);
            alert('URL copied to clipboard! Press Ctrl+D (Cmd+D on Mac) to bookmark this page.');
        };

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        document.documentElement.dataset.theme = savedTheme;

        // Initial render
        function waitForLibraries() {
            const checkInterval = setInterval(() => {
                if (window.pdfjsLib && window.PDFLib) {
                    clearInterval(checkInterval);
                    initPdfJs();
                    render();
                }
            }, 100);

            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                if (!window.pdfjsLib || !window.PDFLib) {
                    console.error('Libraries failed to load within timeout');
                    render();
                }
            }, 10000);
        }

        if (window.pdfjsLib && window.PDFLib) {
            initPdfJs();
            render();
        } else {
            waitForLibraries();
        }
    </script>
</body>
</html>
